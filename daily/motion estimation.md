# 运动估计

# 个人小结

《计算机视觉》书中主要把相关方法分类为参数化运动方法、样条（spline）估计和光流估计三种，对应着基于整体，基于部分到基于像素的层次；
在[2]中分为了基于整体（a）、基于像素（b）、基于块（c）、基于区域（d）四种方法。
其他比较重要的算法还有基于网格、多分辨率等。另外分层运动估计和基于区域的运动估计感觉有一定区别，但是区别又不是太明显，前者是考虑到不同深度物体，并对不同层分别进行估计；后者考虑到不同物体或者同一物体的不同运动趋势的部分。
运动估计最主要的应用场景是视频压缩编码，在这方面主要是使用的块匹配法，并在此基础上发展出了对应的搜索算法等。其他方法中最重要的是光流法对应的dense motion estimation，光流场对应的就是运动场。

```
参考文献：
[1] 丁超, 陈涛. X264的运动估计算法研究[J]. 应用科技, 2009, 36(11):41-45.
[2] Stiller C . Estimating Motion in Image Sequences[J]. IEEE Signal Processing Magazine, 1999, 16(4):70-91.
[3] Bergen J R , Anandan P , Hanna K J , et al. Hierarchical Model-Based Motion Estimation[C]// Computer Vision - ECCV'92, Second European Conference on Computer Vision, Santa Margherita Ligure, Italy, May 19-22, 1992, Proceedings. 1992.
[4] Dosovitskiy A, Fischery P, Ilg E, et al. FlowNet: Learning Optical Flow with Convolutional Networks[C]// IEEE International Conference on Computer Vision. 2015.
[5] Baker S , Roth S , Scharstein D , et al. A Database and Evaluation Methodology for Optical Flow[J]. 2007.
```

# 光流法

## 光流法理论背景

### 1.什么是光流

光流（optical flow）是空间运动物体在观察成像平面上的像素运动的瞬时速度。
光流法是利用图像序列中像素在时间域上的变化以及相邻帧之间的相关性来找到上一帧跟当前帧之间存在的对应关系，从而计算出相邻帧之间物体的运动信息的一种方法。
通常将二维图像平面特定坐标点上的灰度瞬时变化率定义为光流矢量。
一言以概之：所谓光流就是瞬时速率，在时间间隔很小（比如视频的连续前后两帧之间）时，也等同于目标点的位移

### 2.光流的物理意义

一般而言，光流是由于场景中前景目标本身的移动、相机的运动，或者两者的共同运动所产生的。
当人的眼睛观察运动物体时，物体的景象在人眼的视网膜上形成一系列连续变化的图像，这一系列连续变化的信息不断“流过”视网膜（即图像平面），好像一种光的“流”，故称之为光流。光流表达了图像的变化，由于它包含了目标运动的信息，因此可被观察者用来确定目标的运动情况。

### 3.光流场

在空间中，运动可以用运动场描述，而在一个图像平面上，物体的运动往往是通过图像序列中不同图像灰度分布的不同体现的，从而，空间中的运动场转移到图像上就表示为光流场（optical flow field）。
光流场是一个二维矢量场，它反映了图像上每一点灰度的变化趋势，可看成是带有灰度的像素点在图像平面上运动而产生的瞬时速度场。它包含的信息即是各像点的瞬时运动速度矢量信息。
研究光流场的目的就是为了从序列图像中近似计算不能直接得到的运动场。光流场在理想情况下，光流场对应于运动场。

## 光流法基本原理
### 1.基本假设条件
```
（1）亮度恒定不变。即同一目标在不同帧间运动时，其亮度不会发生改变。这是基本光流法的假定（所有光流法变种都必须满足），用于得到光流法基本方程；
（2）时间连续或运动是“小运动”。即时间的变化不会引起目标位置的剧烈变化，相邻帧之间位移要比较小。同样也是光流法不可或缺的假定。
```
### 2.基本约束方程

考虑一个像素I(x,y,t)在第一帧的光强度（其中t代表其所在的时间维度）。它移动了 (dx,dy)的距离到下一帧，用了dt时间。因为是同一个像素点，依据上文提到的第一个假设我们认为该像素在运动前后的光强度是不变的，即：

约束方程只有一个，而方程的未知量有两个，这种情况下无法求得u和v的确切值。此时需要引入另外的约束条件，从不同的角度引入约束条件，导致了不同光流场计算方法。按照理论基础与数学方法的区别把它们分成四种：基于梯度（微分）的方法、基于匹配的方法、基于能量（频率）的方法、基于相位的方法和神经动力学方法。

### 3.几种光流估计算法的简介

#### 1)基于梯度的方法

基于梯度的方法又称为微分法，它是利用时变图像灰度（或其滤波形式）的时空微分（即时空梯度函数）来计算像素的速度矢量。
由于计算简单和较好的结果，该方法得到了广泛应用和研究。典型的代表是Horn-Schunck算法与Lucas-Kanade(LK)算法。
Horn-Schunck算法在光流基本约束方程的基础上附加了全局平滑假设，假设在整个图像上光流的变化是光滑的，即物体运动矢量是平滑的或只是缓慢变化的。
基于此思想，大量的改进算法不断提出。Nagel采用有条件的平滑约束，即通过加权矩阵的控制对梯度进行不同平滑处理；Black和Anandan针对多运动的估计问题，提出了分段平滑的方法。

#### 2) 基于匹配的方法

基于匹配的光流计算方法包括基于特征和区域的两种。
基于特征的方法不断地对目标主要特征进行定位和跟踪，对目标大的运动和亮度变化具有鲁棒性。存在的问题是光流通常很稀疏，而且特征提取和精确匹配也十分困难。
基于区域的方法先对类似的区域进行定位，然后通过相似区域的位移计算光流。这种方法在视频编码中得到了广泛的应用。然而，它计算的光流仍不稠密。另外，这两种方法估计亚像素精度的光流也有困难，计算量很大。

#### 3)基于能量的方法

基于能量的方法又称为基于频率的方法，在使用该类方法的过程中，要获得均匀流场的准确的速度估计，就必须对输入的图像进行时空滤波处理，即对时间和空间的整合，但是这样会降低光流的时间和空间分辨率。基于频率的方法往往会涉及大量的计算，另外，要进行可靠性评价也比较困难。

#### 4)基于相位的方法

基于相位的方法是由Fleet和Jepson提出的，Fleet和Jepson最先提出将相位信息用于光流计算的思想。当我们计算光流的时候，相比亮度信息，图像的相位信息更加可靠，所以利用相位信息获得的光流场具有更好的鲁棒性。基于相位的光流算法的优点是：对图像序列的适用范围较宽，而且速度估计比较精确，但也存在着一些问题：第一，基于相位的模型有一定的合理性，但是有较高的时间复杂性；第二，基于相位的方法通过两帧图像就可以计算出光流，但如果要提高估计精度，就需要花费一定的时间；第三，基于相位的光流计算法对图像序列的时间混叠是比较敏感的。

#### 5)神经动力学方法

神经动力学方法是利用神经网络建立的视觉运动感知的神经动力学模型，它是对生物视觉系统功能与结构比较直接的模拟。
尽管光流计算的神经动力学方法还很不成熟，然而对它的研究却具有极其深远的意义。随着生物视觉研究的不断深入，神经方法无疑会不断完善，也许光流计算乃至计算机视觉的根本出路就在于神经机制的引入。神经网络方法是光流技术的一个发展方向。

### 4.稠密光流与稀疏光流

除了根据原理的不同来区分光流法外，还可以根据所形成的光流场中二维矢量的疏密程度将光流法分为稠密光流与稀疏光流两种。

#### 1) 稠密光流
稠密光流是一种针对图像或指定的某一片区域进行逐点匹配的图像配准方法，它计算图像上所有的点的偏移量，从而形成一个稠密的光流场。通过这个稠密的光流场，可以进行像素级别的图像配准。
Horn-Schunck算法以及基于区域匹配的大多数光流法都属于稠密光流的范畴。
由于光流矢量稠密，所以其配准后的效果也明显优于稀疏光流配准的效果。但是其副作用也是明显的，由于要计算每个点的偏移量，其计算量也明显较大，时效性较差。

#### 2)稀疏光流
与稠密光流相反，稀疏光流并不对图像的每个像素点进行逐点计算。它通常需要指定一组点进行跟踪，这组点最好具有某种明显的特性，例如Harris角点等，那么跟踪就会相对稳定和可靠。稀疏跟踪的计算开销比稠密跟踪小得多。
上文提到的基于特征的匹配方法是典型的属于稀疏光流的算法。

## 参考博客
1. [计算机视觉--光流法(optical flow)简介](https://blog.csdn.net/qq_41368247/article/details/82562165)
2. [光流（optic flow）简介](https://blog.csdn.net/class_brick/article/details/82840941)
3. [光流（optical flow）](https://blog.csdn.net/zhaojun1204/article/details/52911857)


# 视频编码中的运动估计与运动补偿

## 1. H.264的块、帧内预测、帧间预测

H.264/ AVC标准中的基本预测技术是基于块，像素块预测编码包括**帧内（intra）块预测**和**帧间（inter）块预测**，在图像信号压缩编码中，由于亮度信号和色差信号是分别进行处理的，因此，预测又可分亮度信号预测和色差信号预测。
**帧内块预测**是利用相邻像素的相关性，通过当前像素块的左边和上边的像素进行预测，只需对实际值和预测值的差值进行编码。
**帧间预测**是利用先前已编码帧的图像作为参考图像对当前图像进行预测的一种方式。它把参考图像的抽样点通过运动矢量的补偿作为当前图像抽样值的参考值。
帧间预测中所需要的两个主要技术就是**运动估计**和**运动补偿**。


## 2. 运动补偿(MC)

### 2.1 基本概念

运动补偿是通过先前的局部图像来预测、补偿当前的局部图像，它是减少帧序列冗余信息的有效方法。包括**全局运动补偿**和**分块运动补偿**两类。

运动补偿是一种描述相邻帧(相邻在这里表示在编码关系上相邻，在播放顺序上两帧未必相邻) 差别的方法，具体来说是描述前面一帧(相邻在这里表示在编码关系上的前面，在播放顺序上未必在当前帧前面)的每个小块怎样移动到当前帧中的某个位置去。这种方法经常被视频压缩/视频编解码器用来减少视频序列中的空域冗余。它也可以用来进行去交织(deinterlacing)的操作。

最早的运动补偿的设计只是简单的从当前帧中减去参考帧，从而得到通常含有较少能量(或者成为信息)的"残差"，从而可以用较低的码率进行编码。

稍微复杂一点的设计是估计一下整帧场景的移动和场景中物体的移动，并将这些运动通过一定的参数编码到码流中去。这样预测帧上的像素值就是由参考帧上具有一定位移的相应像素值而生成的。这样的方法比简单的相减可以获得能量更小的残差，从而获得更好的压缩比。

### 2.2 I帧、P帧、B帧的运动补偿

通常，图像帧是一组一组进行处理的。每组的第一帧(通常是第一帧)在编码的时候不使用运动估计的办法，这种帧称为**帧内编码帧(Intra frame)或者I帧**。该组中的其它帧使用**帧间编码帧(Inter frame)，通常是P帧**。这种编码方式通常被称为IPPPP，表示编码的时候第一帧是I帧，其它帧是P帧。

在进行预测的时候，不仅仅可以从过去的帧来预测当前帧，还可以使用未来的帧来预测当前帧。当然在编码的时候，未来的帧必须比当前帧更早的编码，也就是说，编码的顺序和播放的顺序是不同的。通常这样的当前帧是使用过去和未来的I帧或者P帧同时进行预测，被称为**双向预测帧，即B帧**。这种编码方式的编码顺序的一个例子为 IBBPBBPBBPBB。

### 2.3 全局运动补偿

在全局运动补偿中，运动模型基本上就是反映摄像机的各种运动，包括平移，旋转，变焦等等。这种模型特别适合对没有运动物体的静止场景的编码。全局运动补偿有下面的一些优点： 

1）该模型仅仅使用少数的参数对全局的运行进行描述，参数所占用的码率基本上可以忽略不计。 

2）该方法不对帧进行分区编码，这避免了分区造成的块效应。 

3）在时间方向的一条直线的点如果在空间方向具有相等的间隔，就对应了在实际空间中连续移动的点。其它的运动估计算法通常会在时间方向引入非连续性。

但缺点是，如果场景中有运动物体的话，全局运动补偿就不足以表示了。这时候应该选用其它的方法。

### 2.4 分块运动补偿

在分块运动补偿中，每帧被分为若干像素块 (在大多数视频编码标准，如MPEG中，是分为16x16的像素块)。从参考帧的某个位置的等大小的块对当前块进行预测，预测的过程中只有平移，平移的大小被称为运动矢量。

对分块运动补偿来说，运动矢量是模型的必要参数，必须一起编码加入码流中。由于运动矢量之间并不是独立的(例如属于同一个运动物体的相邻两块通常运动的相关性很大)，通常使用差分编码来降低码率。这意味着在相邻的运动矢量编码之前对它们作差，只对差分的部分进行编码。使用熵编码对运动矢量的成分进行编码可以进一步消除运动矢量的统计冗余(通常运动矢量的差分集中于0矢量附近)。

运动矢量的值可以是非整数的，此时的运动补偿被称为亚像素精度的运动补偿。这是通过对参考帧像素值进行亚像素级插值，而后进行运动补偿做到的。最简单的亚像素精度运动补偿使用半像素精度，也有使用1/4像素和1/8像素精度的运动补偿算法。更高的亚像素精度可以提高运动补偿的精确度，但是大量的插值操作大大增加了计算复杂度。

分块运动补偿的一个大**缺点**在于在块之间引入的非连续性，通常称为块效应。当块效应严重时，解码图像看起来会有像马赛克一样的效果，严重影响视觉质量。另外一个缺点是，当高频分量较大时，会引起振铃效应。关于高频分量，请参见对运动补偿后的残差进行变换的方法: 变换编码。

### 2.5 运动补偿的原理与步骤

运动补偿的基本原理是，当编码器对图像序列中地第N帧进行处理时，利用运动补偿中地核心技术－运动估值ME（Motion Estimation），得到第N帧得预测帧N´。在实际编码传输时，并不总时传输第N帧，而是第N帧和其预测帧N´得差值△。如果运动估计十分有效，△中得概率基本上分布在零附近，从而导致△比原始图像第N帧得能量小得多，编码传输△所需得比特数也就少得多。

运动补偿的步骤如下：

> （1）图像分割为静止得和运动的两部分，估计物体得位移向量（位移值）。
>
> （2）按照估计得到的位移向量取得前一帧的图像数据。
>
> （3）通过使用预测滤波器，得到前一帧图像数据的预测像素。
>

## 3. 运动估计(ME)

### 3.1 基本概念

将活动图像分为若干块或宏块，并设法搜索出每个块或宏块在邻近帧图像中的位置，并得出两者空间位置的相对偏移量，即运动矢量（MV），得到运动矢量的过程即为运动估计。运动估计的**研究内容**就是如何加速有效地获得足够精确的运动矢量，并且把前一帧所得的运动信息通过运动补偿来进行变换，量化编码，最后输出。

在MPEG-4视频编码中，运动估计相当耗时，对编码的实时性影响很大。因此这里特别强调快速算法。运动估计方法主要有**像素递归法**和**块匹配法**两大类，前者复杂度很高，实际应用较少，后者则在H.263和MPEG中广泛采用。

### 3.2  基本思想

运动估计的基本思想是将图像序列的每一帧分成许多互不重叠的宏块，并认为宏块内所有象素的位移量都相同，然后对每个宏块到参考帧某一给定特定搜索范围内根据一定的匹配准则找出与当前块最相似的块，即匹配块，匹配块与当前块的相对位移即为运动矢量。视频压缩的时候，只需保存运动矢量和残差数据就可以完全恢复出当前块。

运动矢量和经过运动匹配后得到的预测误差共同发送到解码端，在解码端按照运动矢量指明的位置，从已经解码的邻近参考帧图像中找到相应的块或宏块，和预测误差相加后就得到了块或宏块在当前帧中的位置。通过运动估计可以去除帧间冗余度，使得视频传输的比特数大为减少，因此，运动估计是视频压缩处理系统中的一个重要组成部分。

实际应用时，只将运动矢量及最佳匹配块与当前块之间的差值块一起编码传输。在接收端，通过运动矢量在已经恢复的相邻帧中找到当前块的最佳匹配块，并与接收到的差值块相加恢复出当前块，这就是运动补偿基本过程。

### 3.3 运动估计算法

运动估计算法是视频压缩编码的核心算法之一。高质量的运动估计算法是高效视频编码的前提和基础。

其中**块匹配法**（BMA, Block Match Algorithm）由于算法简单和易于硬件实现，被广泛应用于各视频编码标准中。块匹配法的基本思想是先将图像划分为许多子块，然后对当前帧中的每一块根据一定的匹配准则在相邻帧中找出当前块的匹配块，由此得到两者的相对位移，即当前块的运动矢量。在H.264标准的搜索算法中，图像序列的当前帧被划分成互不重叠16×16大小的子块，而每个子块又可划分成更小的子块，当前子块按一定的块匹配准则在参考帧中对应位置的一定搜索范围内寻找最佳匹配块，由此得到运动矢量和匹配误差。

运动估计的估计精度和运算复杂度取决于**搜索策略**和**块匹配准则**。

这里使用H.264推荐算法UMHexagonS（Unsymmetrical-cross Multi-Hexagon-grid Search）作为DSP实现的算法参考，与FS算法比较，它在保证可靠搜索精度的前提下大幅降低搜索复杂度。同时使用绝对差和（SAD, the Sum of Absolute Difference）标准作为匹配准则，它具有便于硬件实现的优点。

### 3.4 块匹配法

对于包含多个运动物体的景物，实际中普遍采用的方法是把一个图像帧分成多个块，使得在每个区域中的运动可以很好地用一个参数化模型表征，这被称为块匹配法，即将图像分成若干个n×n 块（典型值：16×16 宏块） ，为每一个块寻找一个运动矢量 MV，并进行运动补偿预测编码。每一个帧间宏块或块都是根据先前已编码的数据预测出的，根据已编码的宏块、块预测的值和当前宏块、块作差值，结果被压缩传送给解码器，与解码器所需要的其他信息如运动矢量、预测模型等一起用来重复预测过程。每个分割区域都有其对应的运动矢量，并必须对运动矢量以及块的选择方式进行编码和传输。在细节比较多的帧中如果选择较大的块尺寸，意味着用于表明运动矢量和分割区域类型的比特数会少些，但是运动压缩的冗余度要多一些；如果选择小一点的块尺寸，那么运动压缩后冗余度要少一些，但是所需比特数要比较多。因此必须要权衡块尺寸选择上对压缩效果的影响，一般对于细节比较少、比较平坦的区域选择块尺寸大一些，对于图像中细节比较多的区域选择块尺寸小一些。宏块中的每个色度块（Cb 和 Cr） 尺寸宽高都是亮度块的一半，色度块的分割方法和亮度块同样，只是尺寸上宽高都是亮度块一半（如亮度块是 8×16 块尺寸大小，那么色度块就是 4×8，如果亮度块尺寸为 8×4，那么色度块便是 4×2 等等）。每个色度块的运动矢量的水平和垂直坐标都是亮度块的一半。

在块匹配法中，重点研究**块匹配准则**及**搜索方法**。

#### 3.4.1 匹配准则

常见的运动估计匹配准则有三种：MAD、MSE和NCCF，由于MAD没有乘除操作，不需做乘法运算，实现简单方便，所以使用较多。通常使用求和绝对误差（SAD）代替MAD 。

> （1）绝对误差和（SAD, Sum of Absolute Difference）准则；
>
> （2）均方误差（MSE, Mean Square Error）准则；
>
> （3）归一化互相关函数（NCCF, Normalized Cross Correlation Function）准则。
>

在上述三种准则中，SAD准则具有不需乘法运算、实现简单方便的优点而使用最多，但应清楚匹配准则的选用对匹配结果影响不大。

#### 3.4.2 搜索方法

在选取匹配准则后就应进行**寻找最优匹配点**的搜索工作。

> （1）全局搜索算法。该方法是把搜索区域内所有的像素块逐个与当前宏块进行比较，查找具有最小匹配误差的一个像素块为匹配块。这一方法的好处是可以找到最佳的匹配块，坏处是速度太慢。目前全局搜索算法极少使用。
>
> （2）快速搜索算法。该方法按照一定的数学规则进行匹配块的搜索。这一方法的好处是速度快，坏处是可能只能得到次最佳的匹配块。
>

最简单可靠的方法是全搜索法（FS），但计算量太大，不便于实时实现。因此**快速搜索法**应运而生，主要有交叉搜索法、二维对数法和钻石搜索法，其中钻石搜索法被MPEG-4所采纳。

**钻石搜索**（DS, Diamond Search）法以搜索模板形状而得名，具有简单、鲁棒、高效的特点，是现有性能最优的快速搜索算法之一。其基本思想是利用搜索模板的形状和大小对运动估计算法速度及精度产生重要影响的特性。在搜索最优匹配点时，选择小的搜索模板可能会陷入局部最优，选择大的搜索模板则可能无法找到最优点。因此DS算法针对视频图像中运动矢量的基本规律，选用了两种形状大小的搜索模板。

（1）大钻石搜索模板（LDSP, Large Diamond Search Pattern），包含9个候选位置；

（2）小钻石搜索模板（SDSP, Small Diamond Search Pattern），包含5个候选位置。

DS算法搜索过程如下：开始阶段先重复使用大钻石搜索模板，直到最佳匹配块落在大钻石中心。由于LDSP步长大，因而搜索范围广，可实现粗定位，使搜索不会陷于局部最小，当粗定位结束后，可认为最优点就在LDSP 周围8 个点所围菱形区域中。然后再使用小钻石搜索模板来实现最佳匹配块的准确定位，以不产生较大起伏，从而提高运动估计精度。

#### 3.4.4 小结

**提高效率的主要技术：初始搜索点的选择，匹配准则，运动搜索策略。**

1. ##### 初始点的搜索：

  1）直接选择参考帧对应块的中心位置，这种方法简单，但容易陷入局部最优点，如果初始的步长太大，而原点（指待搜索块的中心点在参考帧中的相同位置的对应点）不是最优点时，可能使快速搜索跳出原点周围的区域，而去搜索较远的点，导致搜索方向的不确定性，陷入局部最优。
  2）选择预测的起点，以预测点作为搜索的起点，x264采用将运动估计矢量和参考帧的左边，上边和右上边的MB的中值MV作为起点进行ME。
2. ##### 匹配准则：

  x264中所采用的匹配准则是SAD，SATD。SAD 即绝对误差和，仅反映残差时域差异，影响PSNR值，不能有效反映码流的大小。SATD即将残差经哈德曼变换的4×4块的预测残差绝对值总和，可以将其看作简单的时频变换，其值在一定程度上可以反映生成码流的大小。因此，不用率失真最优化时，可将其作为模式选择的依据。
  一般帧内要对所有的模式进行检测，帧内预测选用SATD。在做运动估计时，一般而言，离最优匹配点越远，匹配误差值SAD越大，这就是有名的单一平面假设。但是，转换后 SATD值并不满足该条件，如果在整像素中运用SATD搜索，容易陷入局部最优点。而在亚象素中，待搜索点不多，各点处的SAD差异相对不大，可以用 SATD选择码流较少的匹配位置。
3. ##### 运动搜索策略：

  x264所采用的运动搜索策略：
  #define X264_ME_DIA                  0 //钻石搜索
  #define X264_ME_HEX                  1 //六边形搜索
  #define X264_ME_UMH                  2 //非对称十字六边形网络搜索
  #define X264_ME_ESA                  3 //全搜索
  #define X264_ME_TESA                 4 //hadamard 全搜索法，这个算法和ESA相比主要是在搜索范围上的变化 

## 4. 其他

### 4.1 视频编解码标准

在视频编解码技术定义方面有两大标准机构。

> 一个是**国际电信联盟（ITU）**，致力于电信应用，已经开发了用于低比特率视频电话的H.26x标准，其中包括 H.261、H.262、H.263与H.264；另一个是**国际标准化组织（ISO）**，主要针对消费类应用，已经针对运动图像压缩定义了MPEG标准。MPEG标准包括MPEG-1、MPEG-2与MPEG-4。

以制订国际通讯标准为主的国际电信联盟电信标准分局ITU-T，在完成H.263（针对视频会议之用的串流视频标准）后，与ISO/IEC机构联手合作，两机构共同成立一个名为JVT（Joint Video Team）的联合工作小组，以MPEG-4技术为基础进行更适于视频会议（Video Conference）运用的衍生发展，联合制订了一个新的标准。这个标准，ITU-T方面称之为H.264。但ISO/IEC的则将这个新标准归纳于MPEG系列，称为MPEG-4 Part 10（第10部分，也叫ISO/IEC 14496-10），MPEG-4 Part 10的另一个代称是MPEG-4 AVC（Advanced Video Coding，先进视频编码）。
 所以，所谓的H.264其实与MPEG－4/AVC就是同一回事，即

> H.264 = MPEG-4 Part 10 = ISO/IEC 14496-10 = MPEG-4 AVC

### 4.2 MPEG-4编码

MPEG-4采用I-VOP、P-VOP、B-VOP三种帧格式来表征不同的运动补偿类型。它采用了H.263中的半像素搜索（half pixel searching）技术和重叠运动补偿（overlapped motion compensation)技术，同时又引入重复填充（repetitive padding）技术和修改的块（多边形）匹配（modified block （polygon）matching）技术以支持任意形状的VOP区域。

此外，为提高运动估计算法精度，MPEG-4采用了MVFAST（Motion Vector Field Adaptive Search Technique）和改进的PMVFAST（Predictive MVFAST）方法用于运动估计。对于全局运动估计，则采用了基于特征的快速顽健的FFRGMET（Feature-based Fast and Robust Global Motion Estimation Technique）方法。

此外Sprite视频编码技术也在MPEG-4中应用广泛，作为其核心技术之一。Sprite又称镶嵌图或背景全景图，是指一个视频对象在视频序列中所有出现部分经拼接而成的一幅图像。利用Sprite可以直接重构该视频对象或对其进行预测补偿编码。Sprite视频编码可视为一种更为先进的运动估计和补偿技术，它能够克服基于固定分块的传统运动估计和补偿技术的不足，MPEG-4正是采用了将传统分块编码技术与Sprite编码技术相结合的策略。

### 4.3 常见的三大开源H.264编码器：JM、X264、T264

（1）JM H264的官方测试源码，实现了264的所有特性，但程序结构冗长，编码复杂度高，不推荐商业应用。

（2）X264 摈弃了264中对编码性能贡献小，但计算复杂度极高的新特性，开源，资源消耗又比较少，推荐商业应用。

（3）T264 编码与X264类似，但是解码器只能解T264编码的。

## 5. 总结

1. 运动估计：简单说就是得到运动矢量的过程。
2. 运动矢量：就是相邻帧前后两个块显示的一样的东西的空间位置的相对对偏移量。这个量有大小和方向。
3. 块匹配准则：就是为了找到前后两帧中相同的那个宏块，这里选取一个匹配准则来判定它们俩之间是否匹配。 
4. 常用的匹配函数
> （1）最小均方差函数（MSE）：MSE (MV) =Σ|f2（x，MV）-f1(x)|
> （2）最小平均绝对值误差（MAD）,等效于常用的绝对差值和（SAD）准则,性能很好,而且相对简单的硬件需求，因而得到了最广泛的应用。MAD (MV) =Σ|f2（x，MV）-f1(x)| 
> （3）阈值差别计数（NTD）：NTD（MV）＝ΣG（f2（x，MV）-f1(x)）

5. 如何选择宏块的大小
> 在细节比较多的帧中如果选择较大的块尺寸，意味着用于表明运动矢量和分割区域类型的比特数会少些，但是运动压缩的冗余度要多一些；如果选择小一点的块尺寸，那么运动压缩后冗余度要少一些，但是所需比特数要比较多。
> 因此必须要权衡块尺寸选择上对压缩效果的影响，一般对于细节比较少、比较平坦的区域选择块尺寸大一些，对于图像中细节比较多的区域选择块尺寸小一些。
> 一句话总结，细多块小，细小块大。

6. 色度块和亮度块关系

> 宏块中的每个色度块 （Cb 和 Cr） 尺寸宽高都是亮度块的一半， 色度块的分割方法和亮度块同样，只是尺寸上宽高都是亮度块一半（如亮度块是 8×16 块尺寸大小，那么色度块就是 4×8，如果亮度块尺寸为 8×4，那么色度块便是 4×2 等等） 。每个色度块的运动矢量的水平和垂直坐标都是亮度块的一半。

7. 运动搜索算法：找到使得匹配误差函数最小的那个块的计算方法
8. 常用运动搜索算法
> （1）全局搜索算法 
> （2）分数精度搜索算法 
> （3）快速搜索算法：二维对数搜索法（菱形、矩形、六边形、十字形）、三步搜索法
> （4）分级搜索范围（DSR）算法 
> （5）混合搜索算法

## 参考博客

1. [运动补偿与运动估计](https://www.cnblogs.com/AndyJee/p/3724917.html)
2. [运动估计与运动补偿](https://www.cnblogs.com/yujing611033/p/6000369.html)
3. [x264源代码简单分析：宏块分析（Analysis）部分-帧间宏块（Inter）](https://blog.csdn.net/leixiaohua1020/article/details/45936267)
4. [运动搜索（运动估计）知识](https://blog.csdn.net/baidu_38172402/article/details/80676606)
5. [运动估计与运动补偿](https://blog.csdn.net/hggjgff/article/details/83828386)
6. [H.264学习笔记3——帧间预测](https://www.cnblogs.com/DwyaneTalk/p/4021365.html)
7. [运动估计与运动补偿(改正!!!)](https://blog.csdn.net/fangbaolei2088/article/details/7671081)
8. [关于运动估计与运动补偿的个人一点理解](https://blog.csdn.net/xiaohaijiejie/article/details/41149717)